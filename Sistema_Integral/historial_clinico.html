<!doctype html>
<html lang="es">

<head>
    <title>Historial Clínico</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <link rel="stylesheet" href="historial_clinico.css">
    <link href="https://fonts.googleapis.com/css2?family=Inria+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/ico/logo_pequeno.ico">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="container mt-3 display: flex">
        <button class="salir" title="salir" onclick="window.location.href='menu.php'" onchange="mostrarFormulario()">
            <div class="salir-box">
                <span class="salir-elem">
                    <svg viewBox="0 0 46 40" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z">
                        </path>
                    </svg>
                </span>
                <span class="button-elem">
                    <svg viewBox="0 0 46 40">
                        <path
                            d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z">
                        </path>
                    </svg>
                </span>
            </div>
        </button>
    </div>

    <div class="container mt-3">
        <div class="text-center mb-2">
            <span class="titulo">HISTORIAL CLÍNICO</span>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="mb-2">¿A quién va dirigido?</label>
                <select id="ambos" class="form-select" onchange="mostrarFormulario()">
                    <option selected disabled>Escoge una opción</option>
                    <option value="maestros" hidden>Maestros</option>
                    <option value="alumnos">Alumnos</option>
                </select>
            </div>
        </div>

        <form action="guardar_historial_alumnos.php" id="historialalumno" style="display: none;" method="post">
            <div class="card fondogenerales">
                <div class="card-body">
                    <div class="seccion-header">
                        DATOS GENERALES
                    </div>

                    <div class="instruccion-busqueda">
                        <div class="icono-info">i</div>
                        <span><strong>Ingrese la matrícula y presione Enter</strong> para buscar al alumno</span>
                    </div>

                    <div class="datos-principales" style="justify-items: center;">
                        <div class="Fila-campos">
                            <div class="campo-grupo text-center" style="width: 200px;">
                                <label for="matricula"><strong> Matrícula </strong></label>
                                <input type="number" class="form-control" name="matricula" id="matricula"
                                    placeholder="Ej: 12345" required style="border: 2px solid #260db6;" />
                            </div>

                        </div>
                    </div>

                    <!-- Datos Principales -->
                    <div class="datos-principales">
                        <div class="fila-campos">


                            <div class="campo-grupo">
                                <label for="fecha1">Fecha</label>
                                <input type="date" class="form-control" name="fecha1" id="fecha1" required />
                            </div>

                            <div class="campo-grupo">
                                <label for="nombre1">Nombre(s)</label>
                                <input type="text" class="form-control" name="nombre1" id="nombre1"
                                    placeholder="Se llenará automáticamente" readonly />
                            </div>

                            <div class="campo-grupo">
                                <label for="apellidos1">Apellidos</label>
                                <input type="text" class="form-control" name="apellidos1" id="apellidos1"
                                    placeholder="Se llenará automáticamente" readonly />
                            </div>

                            <div class="campo-grupo">
                                <label for="sexo1">Sexo</label>
                                <select class="form-select" name="sexo1" id="sexo1">
                                    <option value="" selected disabled>Seleccionar...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Datos Secundarios -->
                    <div class="fila-campos-secundarios">


                        <div class="campo-grupo">
                            <label for="edad1">Edad</label>
                            <input type="text" class="form-control" name="edad1" id="edad1" placeholder="Años"
                                readonly />
                        </div>

                        <div class="campo-grupo">
                            <label for="facultad1">Facultad</label>
                            <select class="form-select" name="facultad1" id="facultad1">
                                <option value="" selected disabled>Seleccionar...</option>
                            </select>
                        </div>

                        <div class="campo-grupo">
                            <label for="carrera1">Carrera</label>
                            <select class="form-select" name="carrera1" id="carrera1">
                                <option value="" selected disabled>Seleccionar...</option>
                            </select>
                        </div>

                        <div class="campo-grupo" style="grid-column: span 2;">
                            <label for="correo1">Correo Electrónico</label>
                            <input type="email" class="form-control" name="correo1" id="correo1"
                                placeholder="ejemplo@correo.com" readonly />
                        </div>
                    </div>

                    <div class="grid-patologias">
                        <!-- Patologías Familiares -->
                        <div class="seccion-patologias">
                            <div class="titulo-patologia">PATOLOGÍAS FAMILIARES</div>

                            <div class="patologia-item">
                                <span class="patologia-label">Sobrepeso-Obesidad</span>
                                <select name="sobrepeso1" id="sobrepeso1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="uno1" id="uno1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Diabetes Mellitus</span>
                                <select name="diabetes1" id="diabetes1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="dos1" id="dos1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Hipertensión Arterial</span>
                                <select name="hiper1" id="hiper1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="tres1" id="tres1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Triglicéridos Alto</span>
                                <select name="trigli1" id="trigli1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="cuatro1" id="cuatro1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Colesterol Alto</span>
                                <select name="colesterol1" id="colesterol1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="cinco1" id="cinco1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Hepatitis</span>
                                <select name="hepatitis1" id="hepatitis1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="seis1" id="seis1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Hígado Graso</span>
                                <select name="higado1" id="higado1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="siete1" id="siete1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Cardiopatías</span>
                                <select name="cardiopatias1" id="cardiopatias1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="ocho1" id="ocho1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Nefropatías</span>
                                <select name="nefropatias1" id="nefropatias1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="nueve1" id="nueve1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Estreñimiento</span>
                                <select name="estrenimiento1" id="estrenimiento1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="diez1" id="diez1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Gastritis</span>
                                <select name="gastritis1" id="gastritis1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="once1" id="once1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Colitis</span>
                                <select name="colitis1" id="colitis1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="doce1" id="doce1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Cáncer</span>
                                <select name="cancer1" id="cancer1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <select name="trece1" id="trece1" class="select-patologia selectParientes" required>
                                    <option value="" selected disabled>Pariente</option>
                                    <option value="padre">Padre</option>
                                    <option value="madre">Madre</option>
                                    <option value="Abuelos Paternos">Abuelos Paternos</option>
                                    <option value="Abuelos Maternos">Abuelos Maternos</option>
                                </select>
                            </div>

                            <div class="patologia-item">
                                <span class="patologia-label">Otra Enfermedad</span>
                                <select name="otra1" id="otra1" class="select-patologia" required>
                                    <option value="" selected disabled>Si/No</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                                <input type="text" class="select-patologia selectParientes" name="otra_cual1"
                                    id="otra_cual1" placeholder="Indique cuál" />
                            </div>
                        </div>

                        <!-- Patologías Personales -->
                        <div class="seccion-patologias">
                            <div class="titulo-patologia">PATOLOGÍAS PERSONALES</div>

                            <div class="patologia-item" style="grid-template-columns: 1fr 1fr;">
                                <span class="patologia-label">¿Tiene alguna enfermedad?</span>
                                <select name="propia1" id="propia1" class="select-patologia" required>
                                    <option value="" selected disabled>Seleccione</option>
                                    <option value="Si">Sí</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div id="enfermedadesContainer1" style="display: none;">
                                <div id="enfermedadesList1">
                                    <div class="enfermedad-card enfermedadItem1">
                                        <div class="campo-grupo mb-3">
                                            <label>Enfermedad</label>
                                            <select name="enfermedad[]" class="select-patologia">
                                                <option value="" selected disabled>Seleccione</option>
                                                <option value="Sobrepeso-Obesidad">Sobrepeso-Obesidad</option>
                                                <option value="Diabetes Mellitus">Diabetes Mellitus</option>
                                                <option value="Hipertensión Arterial">Hipertensión Arterial</option>
                                                <option value="Triglicéridos Alto">Triglicéridos Alto</option>
                                                <option value="Colesterol Alto">Colesterol Alto</option>
                                                <option value="Hepatitis">Hepatitis</option>
                                                <option value="Hígado Graso">Hígado Graso</option>
                                                <option value="Cardiopatías">Cardiopatías</option>
                                                <option value="Nefropatías">Nefropatías</option>
                                                <option value="Estreñimiento">Estreñimiento</option>
                                                <option value="Gastritis">Gastritis</option>
                                                <option value="Colitis">Colitis</option>
                                                <option value="Cáncer">Cáncer</option>
                                                <option value="Otra">Otra</option>
                                            </select>
                                        </div>

                                        <div class="campo-grupo">
                                            <label>Tratamiento</label>
                                            <textarea class="textarea-tratamiento" name="tratamiento[]"
                                                placeholder="Describa el tratamiento..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button type="button" class="btn-agregar" id="agregarEnfermedad1">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                            <path
                                                d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" />
                                        </svg>
                                        Agregar Enfermedad
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary btn-guardar" onclick="guardarFormulario()">
                            <span>Guardar Historial</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function mostrarFormulario() {
            var tipoUsuario = document.getElementById("ambos").value;
            document.getElementById("historialalumno").style.display = tipoUsuario === "alumnos" ? "block" : "none";
        }

        function guardarFormulario() {
            const form = document.getElementById("historialalumno");
            if (form.checkValidity()) {
                enviarFormulario();
            } else {
                form.reportValidity();
            }
        }

        function enviarFormulario() {
            let form = document.getElementById("historialalumno");
            let formData = new FormData(form);

            fetch("guardar_historial_alumnos.php", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "EXCELENTE",
                            text: "Historial Guardado Correctamente",
                            icon: "success"
                        });
                        form.reset();
                        document.getElementById("nombre1").value = "";
                        document.getElementById("apellidos1").value = "";
                        document.getElementById("sexo1").innerHTML = '<option value="" selected disabled>Seleccionar...</option>';
                        document.getElementById("facultad1").innerHTML = '<option value="" selected disabled>Seleccionar...</option>';
                        document.getElementById("carrera1").innerHTML = '<option value="" selected disabled>Seleccionar...</option>';
                    } else {
                        alert("Error al guardar los datos: " + data.error);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    Swal.fire({
                        title: "Ops",
                        text: "Hubo un Problema al Guardar",
                        icon: "warning"
                    });
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Evitar envío con Enter
            document.getElementById("historialalumno").addEventListener("submit", function (event) {
                event.preventDefault();
            });

            // Buscar alumno con Enter en matrícula
            document.getElementById("matricula").addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    const matricula = this.value.trim();
                    if (matricula) {
                        const formulario = document.getElementById("historialalumno");
                        const inputAConservar = document.getElementById("matricula");
                        const valorGuardado = inputAConservar.value;

                        formulario.reset();
                        inputAConservar.value = valorGuardado;
                        buscarAlumno(matricula);
                    }
                }
            });

            // Manejo de patologías personales
            const selectPropia = document.getElementById("propia1");
            const enfermedadesContainer1 = document.getElementById("enfermedadesContainer1");
            const enfermedadesList1 = document.getElementById("enfermedadesList1");
            const agregarEnfermedadBtn1 = document.getElementById("agregarEnfermedad1");

            selectPropia.addEventListener("change", function () {
                enfermedadesContainer1.style.display = this.value === "Si" ? "block" : "none";
            });

            agregarEnfermedadBtn1.addEventListener("click", function () {
                let enfermedadItem1 = document.querySelector(".enfermedadItem1").cloneNode(true);
                enfermedadItem1.querySelectorAll('select, textarea').forEach(el => el.value = '');

                let eliminarBtn1 = document.createElement("button");
                eliminarBtn1.textContent = "Eliminar";
                eliminarBtn1.type = "button";
                eliminarBtn1.classList.add("btn-eliminar", "mt-2");

                eliminarBtn1.addEventListener("click", function () {
                    enfermedadItem1.remove();
                });

                enfermedadItem1.appendChild(eliminarBtn1);
                enfermedadesList1.appendChild(enfermedadItem1);
            });

            // Inicializar selects de parientes deshabilitados
            document.querySelectorAll(".selectParientes").forEach(function (select) {
                select.setAttribute("disabled", "true");
                select.value = "";
            });

            // Habilitar/deshabilitar selects de parientes según respuesta Si/No
            document.querySelectorAll(".select-patologia:not(.selectParientes)").forEach(function (select) {
                select.addEventListener("change", function () {
                    let parientesSelect = this.closest(".patologia-item")?.querySelector(".selectParientes");
                    if (!parientesSelect) return;

                    if (this.value === "Si") {
                        parientesSelect.removeAttribute("disabled");
                        parientesSelect.setAttribute("required", "true");
                    } else if (this.value === "No") {
                        parientesSelect.setAttribute("disabled", "true");
                        parientesSelect.removeAttribute("required");
                        parientesSelect.value = "";
                    }
                });
            });

            // Manejo del campo "Otra Enfermedad"
            const otraSelect = document.getElementById("otra1");
            const otraInput = document.getElementById("otra_cual1");

            if (otraSelect && otraInput) {
                otraInput.setAttribute("disabled", "true");

                otraSelect.addEventListener("change", function () {
                    if (this.value === "Si") {
                        otraInput.removeAttribute("disabled");
                        otraInput.setAttribute("required", "true");
                    } else {
                        otraInput.setAttribute("disabled", "true");
                        otraInput.removeAttribute("required");
                        otraInput.value = "";
                    }
                });
            }
        });

        function buscarAlumno(matricula) {
            fetch(`buscar_alumno.php?matricula=${matricula}`)


                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        Swal.fire({
                            title: 'Sin Alumno',
                            text: 'Se encontró un error: ' + data.error,
                            text: 'Verfica que el alumno esté registrado',
                            icon: 'warning'
                        });
                    } else {
                        document.getElementById("nombre1").value = data.nombres_alum;
                        document.getElementById("apellidos1").value = `${data.ape_paterno_alum} ${data.ape_materno_alum}`;
                        document.getElementById("edad1").value = data.edad_alum;
                        document.getElementById("correo1").value = data.correo_alum;

                        document.getElementById("sexo1").innerHTML = `<option selected>${data.sexo}</option>`;
                        document.getElementById("facultad1").innerHTML = `<option selected>${data.nombre_facultad}</option>`;
                        document.getElementById("carrera1").innerHTML = `<option selected>${data.nombre_carrera}</option>`;

                        document.getElementById("fecha1").value = new Date().toISOString().split("T")[0];
                    }
                })
                .catch(error => {
                    console.error("Error en la solicitud:", error);
                    Swal.fire({
                            title: 'SIN ALUMNO',
                            text: 'Verifica que el Alumno esté Registrado',
                            icon: 'warning'
                        });
                });
        }
    </script>


</body>

</html>